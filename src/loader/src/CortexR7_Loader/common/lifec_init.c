/*
 * Copyright (c) 2015-2019, Renesas Electronics Corporation.
 * All rights reserved.
 */

#include "stdint.h"		/* for uint32_t */
#include "mmio.h"
#include "lifec_register.h"
#include "lifec_init.h"
#include "micro_wait.h"
#include "rcar_def.h"
#include "bl_common.h"

#define SEC_SRC_NON_SECURE	(0x0000001EU)

static void lifec_reg_write(uint32_t addr, uint32_t data);

static void lifec_reg_write(uint32_t addr, uint32_t data)
{
	mmio_write_32((uintptr_t)addr, data);
}

void lifec_init(void)
{
	uint32_t loop;
	uint32_t prr;

	const uint32_t lifec_reg_tbl[][2] = {
		{	SEC_GRP0CR2,	0x00020000U	},
		{	SEC_GRP1CR2,	0x00020000U	},
		{	SAFE_GRP0CR2,	0x00000000U	},
		{	SAFE_GRP1CR2,	0x00000000U	},

		{	SEC_GRP0CR0,	0x00000000U	},
		{	SEC_GRP1CR0,	0x00000000U	},
		{	SAFE_GRP0CR0,	0x00000000U	},
		{	SAFE_GRP1CR0,	0x00000000U	},

		{	SEC_GRP0CR1,	0x00000000U	},
		{	SEC_GRP1CR1,	0x00000000U	},
		{	SAFE_GRP0CR1,	0x00000000U	},
		{	SAFE_GRP1CR1,	0x00000000U	},

		{	SEC_GRP0CR3,	0x00000000U	},
		{	SEC_GRP1CR3,	0x00000000U	},
		{	SAFE_GRP0CR3,	0x00000000U	},
		{	SAFE_GRP1CR3,	0x00000000U	},

		{	SEC_SEL0,	0xFFFFFFFFU	},
		{	SEC_GRP0COND0,	0x00000000U	},
		{	SEC_GRP1COND0,	0x00000000U	},
		{	SEC_READONLY0,	0x00000000U	},
		{	SAFE_GRP0COND0,	0x00000000U	},
		{	SAFE_GRP1COND0,	0x00000000U	},
		{	SAFE_READONLY0,	0x00000000U	},

		{	SEC_SEL1,	0xFFFFFFFFU	},
		{	SEC_GRP0COND1,	0x00000000U	},
		{	SEC_GRP1COND1,	0x00000000U	},
		{	SEC_READONLY1,	0x00000000U	},
		{	SAFE_GRP0COND1,	0x00000000U	},
		{	SAFE_GRP1COND1,	0x00000000U	},
		{	SAFE_READONLY1,	0x00000000U	},

		{	SEC_SEL2,	0xFFFFFFFFU	},
		{	SEC_GRP0COND2,	0x00000000U	},
		{	SEC_GRP1COND2,	0x00000000U	},
		{	SEC_READONLY2,	0x00000000U	},
		{	SAFE_GRP0COND2,	0x00000000U	},
		{	SAFE_GRP1COND2,	0x00000000U	},
		{	SAFE_READONLY2,	0x00000000U	},

		{	SEC_SEL3,	0xFFF7FDFFU	},
		{	SEC_GRP0COND3,	0x00080200U	},
		{	SEC_GRP1COND3,	0x00080200U	},
		{	SEC_READONLY3,	0x00000000U	},
		{	SAFE_GRP0COND3,	0x00000000U	},
		{	SAFE_GRP1COND3,	0x00000000U	},
		{	SAFE_READONLY3,	0x00000000U	},

		{	SEC_SEL4,	0xFFFFFFFFU	},
		{	SEC_GRP0COND4,	0x00000000U	},
		{	SEC_GRP1COND4,	0x00000000U	},
		{	SEC_READONLY4,	0x00000000U	},
		{	SAFE_GRP0COND4,	0x00000000U	},
		{	SAFE_GRP1COND4,	0x00000000U	},
		{	SAFE_READONLY4,	0x00000000U	},

		{	SEC_SEL5,	0xFFFFFFBFU	},
		{	SEC_GRP0COND5,	0x00000040U	},
		{	SEC_GRP1COND5,	0x00000040U	},
		{	SEC_READONLY5,	0x00000000U	},
		{	SAFE_GRP0COND5,	0x00000000U	},
		{	SAFE_GRP1COND5,	0x00000000U	},
		{	SAFE_READONLY5,	0x00000000U	},

#if RCAR_LSI == RCAR_E3
		{	SEC_SEL6,	0xFFFFFBFFU	},
		{	SEC_GRP0COND6,	0x00000400U	},
		{	SEC_GRP1COND6,	0x00000400U	},
#else /* RCAR_LSI == RCAR_E3 */
		{	SEC_SEL6,	0xFFFFCBFFU	},
		{	SEC_GRP0COND6,	0x00003400U	},
		{	SEC_GRP1COND6,	0x00003400U	},
#endif /* RCAR_LSI == RCAR_E3 */
		{	SEC_READONLY6,	0x00000000U	},
		{	SAFE_GRP0COND6,	0x00000000U	},
		{	SAFE_GRP1COND6,	0x00000000U	},
		{	SAFE_READONLY6,	0x00000000U	},

		{	SEC_SEL7,	0xFFFFFFFFU	},
		{	SEC_GRP0COND7,	0x00000000U	},
		{	SEC_GRP1COND7,	0x00000000U	},
		{	SEC_READONLY7,	0x00000000U	},
		{	SAFE_GRP0COND7,	0x00000000U	},
		{	SAFE_GRP1COND7,	0x00000000U	},
		{	SAFE_READONLY7,	0x00000000U	},

		{	SEC_SEL8,	0xFFFFFFFFU	},
		{	SEC_GRP0COND8,	0x00000000U	},
		{	SEC_GRP1COND8,	0x00000000U	},
		{	SEC_READONLY8,	0x00000000U	},
		{	SAFE_GRP0COND8,	0x00000000U	},
		{	SAFE_GRP1COND8,	0x00000000U	},
		{	SAFE_READONLY8,	0x00000000U	},

		{	SEC_SEL9,	0xFFFFFFFFU	},
		{	SEC_GRP0COND9,	0x00000000U	},
		{	SEC_GRP1COND9,	0x00000000U	},
		{	SEC_READONLY9,	0x00000000U	},
		{	SAFE_GRP0COND9,	0x00000000U	},
		{	SAFE_GRP1COND9,	0x00000000U	},
		{	SAFE_READONLY9,	0x00000000U	},

		{	SEC_SEL10,	 0xFFFFFFFFU	},
		{	SEC_GRP0COND10,	 0x00000000U	},
		{	SEC_GRP1COND10,	 0x00000000U	},
		{	SEC_READONLY10,	 0x00000000U	},
		{	SAFE_GRP0COND10, 0x00000000U	},
		{	SAFE_GRP1COND10, 0x00000000U	},
		{	SAFE_READONLY10, 0x00000000U	},

		{	SEC_SEL11,	 0xFFFFFFFFU	},
		{	SEC_GRP0COND11,	 0x00000000U	},
		{	SEC_GRP1COND11,	 0x00000000U	},
		{	SEC_READONLY11,	 0x00000000U	},
		{	SAFE_GRP0COND11, 0x00000000U	},
		{	SAFE_GRP1COND11, 0x00000000U	},
		{	SAFE_READONLY11, 0x00000000U	},

		{	SEC_SEL12,	 0xFFFFFFFFU	},
		{	SEC_GRP0COND12,	 0x00000000U	},
		{	SEC_GRP1COND12,	 0x00000000U	},
		{	SEC_READONLY12,	 0x00000000U	},
		{	SAFE_GRP0COND12, 0x00000000U	},
		{	SAFE_GRP1COND12, 0x00000000U	},
		{	SAFE_READONLY12, 0x00000000U	},

		{	SEC_SEL13,	 0xFFBFFFFFU	},
		{	SEC_GRP0COND13,	 0x00400000U	},
		{	SEC_GRP1COND13,	 0x00400000U	},
		{	SEC_READONLY13,	 0x00000000U	},
		{	SAFE_GRP0COND13, 0x00000000U	},
		{	SAFE_GRP1COND13, 0x00000000U	},
		{	SAFE_READONLY13, 0x00000000U	},

		{	SEC_SEL14,	 0xF3FFFFFFU	},
		{	SEC_GRP0COND14,	 0x0C000000U	},
		{	SEC_GRP1COND14,	 0x0C000000U	},
		{	SEC_READONLY14,	 0x00000000U	},
		{	SAFE_GRP0COND14, 0x00000000U	},
		{	SAFE_GRP1COND14, 0x00000000U	},
		{	SAFE_READONLY14, 0x00000000U	},

		{	SEC_SEL15,	 0xFFFFFF3FU	},
		{	SEC_GRP0COND15,	 0x000000C0U	},
		{	SEC_GRP1COND15,	 0x000000C0U	},
		{	SEC_READONLY15,	 0x00000000U	},
		{	SAFE_GRP0COND15, 0x00000000U	},
		{	SAFE_GRP1COND15, 0x00000000U	},
		{	SAFE_READONLY15, 0x00000000U	},
	};

	prr = mmio_read_32(RCAR_PRR);

	for (loop = 0U;
		loop < ARRAY_SIZE(lifec_reg_tbl);
		loop++) {
		lifec_reg_write(lifec_reg_tbl[loop][0], lifec_reg_tbl[loop][1]);
	}

	/*
	 * Dummy read to the last written access protection
	 * setting register is necessary for wait time.
	 */
	if (((prr & RCAR_PRODUCT_MASK) == RCAR_PRODUCT_H3)
		&& ((prr & RCAR_CUT_MASK) < RCAR_CUT_VER20)) {
		/* H3 Ver.1.0/1.1 10usec wait */
		micro_wait(10U);
	} else {
		/* dummy read */
		(void)mmio_read_32(SAFE_READONLY15);
	}
}

void lifec_cr7_setting(void)
{
#if RCAR_LIFEC_NON_SECURE_MASTER

	uint32_t prr;

	prr = mmio_read_32(RCAR_PRR);

	/*
	 * Security attribute setting for master ports
	 * (CR7 Secure -> Non Secure)
	 */
	lifec_reg_write(SEC_SRC, SEC_SRC_NON_SECURE);


	if (((prr & RCAR_PRODUCT_MASK) == RCAR_PRODUCT_H3)
		&& ((prr & RCAR_CUT_MASK) < RCAR_CUT_VER20)) {
		/* H3 Ver.1.0/1.1 10usec wait */
		micro_wait(10U);
	} else {
		/* dummy read */
		(void)mmio_read_32(SEC_SRC);
	}
#endif
}

